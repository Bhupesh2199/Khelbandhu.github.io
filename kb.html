<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khelbandhu - Social Sports Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f3f4f6; --text-light: #1f2937; --card-light: white; --border-light: #e5e7eb;
            --bg-dark: #0f172a; --text-dark: #e2e8f0; --card-dark: #1e293b; --border-dark: #334155;
        }
        html.dark { scrollbar-color: #4b5563 #1e293b; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease, color 0.3s ease; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glassmorphism { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }

        input[type=range]::-webkit-slider-thumb { transition: transform 0.2s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        
        .chat-bubble-sent { background-color: #f97316; color: white; }
        .chat-bubble-received { background-color: #e5e7eb; color: #1f2937; }
        .dark .chat-bubble-received { background-color: #334155; color: #e2e8f0; }

        .toast {
            visibility: hidden; opacity: 0; transition: visibility 0s 0.5s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible; opacity: 1; transition: opacity 0.5s linear;
        }
        
        .modal { display: none; }
        .modal.flex { display: flex; }

    </style>
</head>
<body class="bg-light text-light dark:bg-dark dark:text-dark">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-24 right-4 z-[99]"></div>

    <!-- HTML Templates -->
    <template id="player-card-template">
        <div class="card bg-card border border-border rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer p-5">
            <div class="flex items-center mb-4">
                <img src="" alt="" class="w-16 h-16 rounded-full mr-4 border-2 object-cover">
                <div>
                    <h3 class="text-xl font-bold flex items-center"></h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400"></p>
                </div>
            </div>
            <div class="flex justify-between items-center">
                <div class="flex gap-3 items-center activities-container"></div>
                <span class="player-type text-xs font-semibold px-2.5 py-1 rounded-full"></span>
            </div>
        </div>
    </template>
    
    <template id="event-card-template">
         <div class="card bg-card border border-border rounded-lg shadow-md p-5 transition-all hover:shadow-lg">
            <div class="flex justify-between items-start">
                <div>
                    <p class="event-activity text-2xl mb-1"></p>
                    <h3 class="event-title text-xl font-bold"></h3>
                    <p class="event-location text-sm text-gray-500 dark:text-gray-400"></p>
                    <p class="event-time text-sm text-gray-500 dark:text-gray-400"></p>
                </div>
                <div class="text-center">
                    <p class="event-date-month font-bold text-orange-500"></p>
                    <p class="event-date-day text-3xl font-extrabold"></p>
                </div>
            </div>
            <div class="flex items-center justify-between mt-4">
                <div class="flex items-center -space-x-2 event-attendees"></div>
                <button class="join-event-btn bg-orange-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-orange-600 transition text-sm"></button>
            </div>
        </div>
    </template>

    <div class="container mx-auto p-4 max-w-4xl min-h-screen pb-24">
        <!-- Header -->
        <header class="flex justify-between items-center text-center my-6 md:my-8">
             <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
             </button>
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500">Khelbandhu</h1>
                <p id="header-subtitle" class="text-gray-600 dark:text-gray-400 mt-2"></p>
            </div>
            <div class="relative">
                <button id="notifications-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-5-5.917V5a1 1 0 00-2 0v.083A6 6 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span id="notification-dot" class="absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 border-2 border-white dark:border-gray-800 hidden"></span>
                </button>
                <div id="notifications-panel" class="absolute right-0 mt-2 w-80 bg-card border border-border rounded-lg shadow-xl z-20 hidden"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <div id="discover-page" class="page"></div>
            <div id="events-page" class="page"></div>
            <div id="my-profile-page" class="page"></div>
            <div id="inbox-page" class="page"></div>
            <div id="trainer-page" class="page"></div>
            <div id="create-event-page" class="page"></div>
        </main>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-4xl mx-auto p-2 z-10">
        <div class="glassmorphism rounded-full shadow-lg flex justify-around">
             <button data-page="discover-page" class="nav-btn flex-1 p-3 text-center text-orange-500"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span class="text-xs font-medium">Discover</span></button>
            <button data-page="events-page" class="nav-btn flex-1 p-3 text-center text-gray-500 dark:text-gray-400"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="text-xs font-medium">Events</span></button>
            <button data-page="my-profile-page" class="nav-btn flex-1 p-3 text-center text-gray-500 dark:text-gray-400"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span class="text-xs font-medium">Profile</span></button>
            <button data-page="inbox-page" class="nav-btn flex-1 p-3 text-center text-gray-500 dark:text-gray-400"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><span class="text-xs font-medium">Inbox</span></button>
        </div>
    </nav>
    
    <!-- Modals -->
    <div id="profile-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4"></div>
    <div id="chat-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4"></div>

    <script>
        const App = {};

        // --- DETAILED IMPLEMENTATION (SELF-EXECUTING) ---
        (function(app) {
            // STATE
            app.state = {
                theme: 'light',
                activePage: 'discover-page',
                activeFilter: 'all',
                searchRadius: 10,
                currentUserLocation: { lat: 28.6139, lon: 77.2090 }, // Default to Delhi
                myProfile: {
                    id: 0, name: 'Aditya Rao', age: 28, location: 'South Delhi, India',
                    bio: "Software developer by day, aspiring cricketer by weekend. Looking for regular practice partners in South Delhi.", 
                    activities: ['cricket', 'gym', 'running'], type: 'Regular', isTrainer: false,
                    skillLevels: { cricket: 'Intermediate', gym: 'Beginner', running: 'Intermediate' }, 
                    connections: [2, 4, 8],
                    profileImage: 'https://placehold.co/100x100/22c55e/FFFFFF/png?text=AR',
                    certificates: [
                        { name: 'Certified Personal Trainer - ACE', file: 'ace_certificate.pdf' },
                        { name: 'First Aid & CPR Certified', file: 'cpr_certificate.pdf' }
                    ]
                },
                players: [
                    { id: 1, name: 'Rohan Sharma', lat: 28.6139, lon: 77.2090, bio: 'State-level cricketer and certified fitness coach. Serious about my training.', activities: ['cricket', 'gym'], type: 'Regular', isTrainer: true, skillLevels: { cricket: 'Advanced', gym: 'Advanced' }, connections: [3, 5], profileImage: 'https://placehold.co/100x100/3b82f6/FFFFFF/png?text=RS' },
                    { id: 2, name: 'Priya Patel', lat: 28.6145, lon: 77.2085, bio: 'Yoga instructor and marathon runner. I enjoy peaceful morning runs.', activities: ['yoga', 'running'], type: 'Regular', isTrainer: true, skillLevels: { yoga: 'Advanced', running: 'Intermediate' }, connections: [0, 6], profileImage: 'https://placehold.co/100x100/ec4899/FFFFFF/png?text=PP' },
                    { id: 3, name: 'Amit Kumar', lat: 28.6130, lon: 77.2100, bio: 'Just moved to the city, looking for a basketball court and people to play with.', activities: ['basketball', 'gym'], type: 'Regular', isTrainer: false, skillLevels: { basketball: 'Advanced', gym: 'Intermediate' }, connections: [1], profileImage: 'https://placehold.co/100x100/f97316/FFFFFF/png?text=AK' },
                    { id: 4, name: 'Sneha Verma', lat: 28.6150, lon: 77.2110, bio: 'I run to explore the city! Open to joining running groups.', activities: ['running'], type: 'Occasional', isTrainer: false, skillLevels: { running: 'Intermediate' }, connections: [0], profileImage: 'https://placehold.co/100x100/8b5cf6/FFFFFF/png?text=SV' },
                    { id: 5, name: 'Vikram Singh', lat: 28.6125, lon: 77.2095, bio: 'Casual weekend football and cricket. Not too competitive, just for fun!', activities: ['cricket', 'football'], type: 'Occasional', isTrainer: false, skillLevels: { cricket: 'Beginner', football: 'Intermediate' }, connections: [1], profileImage: 'https://placehold.co/100x100/f59e0b/FFFFFF/png?text=VS' },
                    { id: 6, name: 'Anjali Gupta', lat: 28.6160, lon: 77.2120, bio: 'Finding my zen with yoga. Also looking for a female gym partner.', activities: ['yoga', 'gym'], type: 'Regular', isTrainer: false, skillLevels: { yoga: 'Intermediate', gym: 'Beginner' }, connections: [2], profileImage: 'https://placehold.co/100x100/14b8a6/FFFFFF/png?text=AG' },
                    { id: 7, name: 'Karan Malhotra', lat: 28.5273, lon: 77.2066, // South Delhi
                        bio: 'Ex-university football captain. Now just trying to stay in shape. Up for intense 5-a-side matches.', activities: ['football', 'gym'], type: 'Regular', isTrainer: false, skillLevels: { football: 'Advanced', gym: 'Intermediate' }, connections: [], profileImage: 'https://placehold.co/100x100/ef4444/FFFFFF/png?text=KM'
                    },
                    { id: 8, name: 'Isha Nair', lat: 28.5355, lon: 77.2244, // Near Lodhi Garden
                        bio: 'Beginner at yoga, looking for patient partners to practice with at Lodhi Garden on weekends.', activities: ['yoga'], type: 'Occasional', isTrainer: false, skillLevels: { yoga: 'Beginner' }, connections: [0], profileImage: 'https://placehold.co/100x100/d946ef/FFFFFF/png?text=IN'
                    },
                    { id: 9, name: 'Arjun Mehra', lat: 28.4595, lon: 77.0266, // Gurgaon
                        bio: 'Bodybuilder and long-distance runner. Looking for a serious gym buddy in Gurgaon.', activities: ['gym', 'running'], type: 'Regular', isTrainer: false, skillLevels: { gym: 'Advanced', running: 'Advanced' }, connections: [], profileImage: 'https://placehold.co/100x100/10b981/FFFFFF/png?text=AM'
                    },
                     { id: 10, name: 'Meera Krishnan', lat: 28.5355, lon: 77.3910, // Noida
                        bio: 'Tech professional who de-stresses with yoga and basketball. Let\'s play after work!', activities: ['yoga', 'basketball'], type: 'Occasional', isTrainer: false, skillLevels: { yoga: 'Intermediate', basketball: 'Beginner' }, connections: [], profileImage: 'https://placehold.co/100x100/6366f1/FFFFFF/png?text=MK'
                    },
                    { id: 11, name: 'Sahil Khan', lat: 28.4089, lon: 77.3178, // Faridabad
                        bio: 'Love a good game of football on a Sunday morning. Not a pro, just play for the love of the game.', activities: ['football'], type: 'Occasional', isTrainer: false, skillLevels: { football: 'Intermediate' }, connections: [], profileImage: 'https://placehold.co/100x100/f43f5e/FFFFFF/png?text=SK'
                    },
                    { id: 12, name: 'Kavita Joshi', lat: 28.6304, lon: 77.2177, // Connaught Place
                        bio: 'Morning runner, usually around CP. Preparing for the next half-marathon.', activities: ['running'], type: 'Regular', isTrainer: false, skillLevels: { running: 'Advanced' }, connections: [], profileImage: 'https://placehold.co/100x100/eab308/FFFFFF/png?text=KJ'
                    }
                ],
                events: [
                    { id: 1, title: "Weekend Cricket Match", activity: "cricket", location: "Nehru Park, Chanakyapuri", date: "2025-09-13T10:00", createdBy: 1, attendees: [1, 3, 5, 0] },
                    { id: 2, title: "Sunrise Yoga Session", activity: "yoga", location: "Lodhi Garden", date: "2025-09-14T07:00", createdBy: 2, attendees: [2, 6, 8] },
                    { id: 3, title: "Football Fridays", activity: "football", location: "Siri Fort Sports Complex", date: "2025-09-12T18:00", createdBy: 5, attendees: [5, 7, 11] },
                    { id: 4, title: "5K Community Run", activity: "running", location: "India Gate Circle", date: "2025-09-21T06:30", createdBy: 4, attendees: [4, 2, 0, 12] },
                    { id: 5, title: "3v3 Basketball Showdown", activity: "basketball", location: "Noida Stadium", date: "2025-09-20T17:00", createdBy: 3, attendees: [3, 10] },
                ],
                chats: { 
                    1: { name: 'Rohan Sharma', messages: [ { sender: 1, text: "Hey, are you free for cricket tomorrow?", time: "9:30 AM" }, { sender: 0, text: "Yeah, sounds good! What time?", time: "9:32 AM" }, { sender: 1, text: "Around 10 AM at Nehru Park?", time: "9:33 AM" } ] },
                    2: { name: 'Priya Patel', messages: [ { sender: 2, text: "It was great running with you at India Gate!", time: "Yesterday" }, { sender: 0, text: "You too! Your pace is amazing.", time: "Yesterday" } ] },
                    4: { name: 'Sneha Verma', messages: [ { sender: 4, text: "Are you joining the 5K run this Sunday?", time: "2 days ago" } ] },
                    8: { name: 'Isha Nair', messages: [ { sender: 8, text: "Hi! I saw you are also a beginner at yoga. Want to practice together sometime?", time: "3 days ago" }, { sender: 0, text: "Definitely! I'm free this weekend.", time: "2 days ago" }, { sender: 8, text: "Great! How about Lodhi Garden on Sunday morning?", time: "2 days ago" } ] },
                },
                notifications: [
                    { id:1, type: 'connect_request', from: 3, text: 'Amit Kumar sent you a connection request.', read: false},
                    { id:2, type: 'event_invite', from: 7, text: 'Karan Malhotra invited you to "Football Fridays".', read: false},
                    { id:3, type: 'message', from: 2, text: 'Priya Patel sent you a message.', read: true},
                    { id:4, type: 'connect_request', from: 6, text: 'Anjali Gupta sent you a connection request.', read: true},
                ]
            };

            // CONSTANTS
            app.constants = {
                activityIcons: { cricket: 'üèè', basketball: 'üèÄ', football: '‚öΩ', gym: 'üèãÔ∏è', running: 'üèÉ', yoga: 'üßò' },
                skillColors: { Beginner: 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300', Intermediate: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300', Advanced: 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300' },
                trainerBadgeHtml: `<span class="ml-2 text-xs font-semibold px-2.5 py-1 rounded-full bg-blue-500 text-white flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zM10 11a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path></svg>Certified Trainer</span>`
            };
            
            app.elements = {};

            app.init = function() {
                app.elements = {
                    html: document.documentElement,
                    body: document.body,
                    headerSubtitle: document.getElementById('header-subtitle'),
                    navButtons: document.querySelectorAll('.nav-btn'),
                    pages: document.querySelectorAll('.page'),
                    main: document.querySelector('main'),
                    themeToggle: document.getElementById('theme-toggle'),
                    themeIconLight: document.getElementById('theme-icon-light'),
                    themeIconDark: document.getElementById('theme-icon-dark'),
                    notificationsBtn: document.getElementById('notifications-btn'),
                    notificationDot: document.getElementById('notification-dot'),
                    notificationsPanel: document.getElementById('notifications-panel'),
                    toastContainer: document.getElementById('toast-container'),
                    profileModal: document.getElementById('profile-modal'),
                    chatModal: document.getElementById('chat-modal'),
                    playerCardTemplate: document.getElementById('player-card-template'),
                    eventCardTemplate: document.getElementById('event-card-template')
                };
                app.setupTheme();
                app.renderAllPages();
                app.bindEvents();
                app.switchPage('discover-page');
                app.updateNotifications();
                app.utils.getLocation();
            };
            
            app.setupTheme = function() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                app.state.theme = savedTheme;
                if (savedTheme === 'dark') {
                    app.elements.html.classList.add('dark');
                    app.elements.themeIconLight.classList.add('hidden');
                    app.elements.themeIconDark.classList.remove('hidden');
                } else {
                    app.elements.html.classList.remove('dark');
                    app.elements.themeIconLight.classList.remove('hidden');
                    app.elements.themeIconDark.classList.add('hidden');
                }
            };
            
            app.bindEvents = function() {
                app.elements.navButtons.forEach(btn => btn.addEventListener('click', app.handlers.handleNavClick));
                app.elements.themeToggle.addEventListener('click', app.handlers.handleThemeToggle);
                app.elements.notificationsBtn.addEventListener('click', app.handlers.handleNotificationsToggle);
                document.addEventListener('click', (e) => { // Close notifications panel on outside click
                    if (!app.elements.notificationsBtn.contains(e.target) && !app.elements.notificationsPanel.contains(e.target)) {
                        app.elements.notificationsPanel.classList.add('hidden');
                    }
                });
            };

            app.switchPage = function(pageId) {
                app.state.activePage = pageId;
                app.elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                app.elements.navButtons.forEach(btn => {
                    const isTargetPage = btn.dataset.page === pageId;
                    btn.classList.toggle('text-orange-500', isTargetPage);
                    btn.classList.toggle('text-gray-500', !isTargetPage);
                    btn.classList.toggle('dark:text-gray-400', !isTargetPage);
                });
                const subtitles = { 'discover-page': 'Connect with players...', 'events-page': 'Find or create local events', 'my-profile-page': 'View and manage your profile', 'inbox-page': 'Your conversations' };
                app.elements.headerSubtitle.textContent = subtitles[pageId] || '';

                // Render page content when switched to
                if (pageId === 'events-page') app.renderEventList();
                if (pageId === 'discover-page') app.renderPlayerList();
                if (pageId === 'my-profile-page') app.renderMyProfilePage();
                if (pageId === 'inbox-page') app.renderInboxPage();
            };
            
            app.updateNotifications = function() {
                const unreadCount = app.state.notifications.filter(n => !n.read).length;
                app.elements.notificationDot.classList.toggle('hidden', unreadCount === 0);
            };

            app.renderAllPages = function() {
                // Discover page skeleton
                const discoverPage = document.getElementById('discover-page');
                discoverPage.innerHTML = `<div id="location-status" class="bg-blue-100 dark:bg-blue-900/30 border-l-4 border-blue-500 text-blue-700 dark:text-blue-300 p-4 rounded-lg mb-6" role="alert">
                        <p class="font-bold">Finding players near you...</p><p>Using default location. Allow access for accurate results.</p>
                    </div>
                    <div id="filters" class="mb-6 p-4 bg-card border border-border rounded-lg shadow-sm">
                         <div class="mb-4"><label for="distance-range" class="block text-lg font-semibold mb-2">Search Radius: <span id="distance-label" class="text-orange-500 font-bold">10 km</span></label><input type="range" id="distance-range" min="1" max="50" value="10" class="w-full"></div>
                         <h2 class="text-lg font-semibold mb-3">Filter by Activity</h2>
                         <div class="flex flex-wrap gap-2">${Object.keys(app.constants.activityIcons).map(act => `<button class="filter-btn bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-full shadow-md hover:bg-gray-200 dark:hover:bg-slate-600 transition" data-activity="${act}">${app.constants.activityIcons[act]} ${act.charAt(0).toUpperCase() + act.slice(1)}</button>`).join('')}<button class="filter-btn bg-orange-500 text-white px-4 py-2 rounded-full shadow-md hover:bg-orange-600 transition" data-activity="all">All</button></div>
                    </div>
                    <div id="player-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="no-players-message" class="hidden text-center py-10"><p class="text-gray-600 dark:text-gray-400 text-lg">No players found. Try expanding your search!</p></div>`;
                
                // Events page skeleton
                const eventsPage = document.getElementById('events-page');
                eventsPage.innerHTML = `<div class="flex justify-end mb-4"><button id="create-event-btn" class="bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:scale-105 transition transform">Create Event +</button></div><div id="event-list" class="space-y-4"></div>`;

                // Add event listeners for discover page elements
                discoverPage.querySelector('#distance-range').addEventListener('input', app.handlers.handleDistanceChange);
                discoverPage.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', app.handlers.handleFilterClick));
            };
            
            app.renderPlayerList = function() {
                const container = document.getElementById('player-list');
                if (!container) return;
                container.innerHTML = '';
                const { currentUserLocation, players, searchRadius, activeFilter } = app.state;
                
                const filteredPlayers = players.filter(player => {
                    const distance = app.utils.calculateDistance(currentUserLocation.lat, currentUserLocation.lon, player.lat, player.lon);
                    const isInRadius = distance <= searchRadius;
                    const matchesActivity = activeFilter === 'all' || player.activities.includes(activeFilter);
                    return isInRadius && matchesActivity;
                });

                document.getElementById('no-players-message').classList.toggle('hidden', filteredPlayers.length > 0);

                filteredPlayers.forEach(player => {
                    const card = app.elements.playerCardTemplate.content.cloneNode(true).firstElementChild;
                    const distance = app.utils.calculateDistance(currentUserLocation.lat, currentUserLocation.lon, player.lat, player.lon).toFixed(1);
                    
                    card.querySelector('img').src = player.profileImage;
                    card.querySelector('img').alt = player.name;
                    card.querySelector('h3').textContent = player.name;
                    if (player.isTrainer) card.querySelector('h3').innerHTML += app.constants.trainerBadgeHtml;
                    card.querySelector('p').textContent = `~ ${distance} km away`;
                    
                    const activitiesContainer = card.querySelector('.activities-container');
                    player.activities.slice(0, 3).forEach(act => {
                        const span = document.createElement('span');
                        span.className = 'text-2xl';
                        span.textContent = app.constants.activityIcons[act];
                        activitiesContainer.appendChild(span);
                    });

                    const playerType = card.querySelector('.player-type');
                    playerType.textContent = player.type;
                    if (player.type === 'Regular') {
                        playerType.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/50', 'dark:text-green-300');
                    } else {
                        playerType.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900/50', 'dark:text-yellow-300');
                    }
                    
                    container.appendChild(card);
                });
            };

            app.renderEventList = function() {
                const container = document.getElementById('event-list');
                if (!container) return;
                container.innerHTML = '';
                app.state.events.forEach(event => {
                    const card = app.elements.eventCardTemplate.content.cloneNode(true).firstElementChild;
                    card.querySelector('.event-title').textContent = event.title;
                    card.querySelector('.event-activity').textContent = app.constants.activityIcons[event.activity];
                    card.querySelector('.event-location').textContent = `üìç ${event.location}`;
                    const eventDate = new Date(event.date);
                    card.querySelector('.event-time').textContent = `‚è∞ ${eventDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    card.querySelector('.event-date-month').textContent = eventDate.toLocaleString('default', { month: 'short' }).toUpperCase();
                    card.querySelector('.event-date-day').textContent = eventDate.getDate();
                    
                    const attendeesContainer = card.querySelector('.event-attendees');
                    event.attendees.slice(0, 5).forEach(pId => {
                         const player = pId === 0 ? app.state.myProfile : app.state.players.find(p => p.id === pId);
                         if(player) {
                            const img = document.createElement('img');
                            img.className = "w-8 h-8 rounded-full border-2 border-white dark:border-gray-800 object-cover";
                            img.src = player.profileImage;
                            img.alt = player.name;
                            attendeesContainer.appendChild(img);
                         }
                    });

                    const joinBtn = card.querySelector('.join-event-btn');
                    joinBtn.dataset.eventId = event.id;
                    if(event.attendees.includes(app.state.myProfile.id)) {
                        joinBtn.textContent = 'Joined';
                        joinBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                        joinBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
                        joinBtn.disabled = true;
                    } else {
                        joinBtn.textContent = 'Join Event';
                    }
                    container.appendChild(card);
                });
            };

            app.renderMyProfilePage = function() {
                const page = document.getElementById('my-profile-page');
                const profile = app.state.myProfile;
                page.innerHTML = `
                    <div class="bg-card border border-border rounded-lg shadow-lg p-6">
                        <div class="flex flex-col sm:flex-row items-center sm:items-start text-center sm:text-left">
                            <img src="${profile.profileImage}" alt="${profile.name}" class="w-32 h-32 rounded-full border-4 border-orange-500 object-cover mb-4 sm:mb-0 sm:mr-6">
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h2 class="text-3xl font-bold">${profile.name}</h2>
                                        <p class="text-gray-500 dark:text-gray-400">Age ${profile.age} &bull; ${profile.location}</p>
                                    </div>
                                    <button id="edit-profile-btn" class="bg-gray-200 dark:bg-gray-700 text-sm font-semibold py-2 px-4 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition">Edit Profile</button>
                                </div>
                                <p class="mt-4 text-gray-600 dark:text-gray-300">${profile.bio}</p>
                            </div>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-xl font-bold mb-4">My Activities & Skills</h3>
                            <div class="space-y-3">
                                ${profile.activities.map(act => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-800 rounded-lg">
                                        <span class="font-semibold">${app.constants.activityIcons[act]} ${act.charAt(0).toUpperCase() + act.slice(1)}</span>
                                        <span class="text-sm font-semibold px-2 py-1 rounded-full ${app.constants.skillColors[profile.skillLevels[act] || 'Beginner']}">${profile.skillLevels[act] || 'Beginner'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mt-8">
                             <h3 class="text-xl font-bold mb-4">Certificates & Achievements</h3>
                             <div id="certificate-list" class="space-y-3">
                                ${profile.certificates.length > 0 ? profile.certificates.map(cert => `
                                    <div class="flex items-center p-3 bg-gray-50 dark:bg-slate-800 rounded-lg">
                                        <svg class="w-6 h-6 text-yellow-500 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                                        <span class="font-semibold">${cert.name}</span>
                                    </div>
                                `).join('') : `<p class="text-gray-500 dark:text-gray-400">No certificates uploaded yet.</p>`}
                             </div>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-xl font-bold mb-4">My Connections (${profile.connections.length})</h3>
                            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4">
                                ${profile.connections.map(id => {
                                    const p = app.state.players.find(player => player.id === id);
                                    return p ? `<div class="text-center"><img src="${p.profileImage}" class="w-16 h-16 rounded-full mx-auto object-cover"><p class="text-sm mt-2 font-semibold">${p.name}</p></div>` : '';
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('edit-profile-btn').addEventListener('click', app.handlers.handleEditProfileOpen);
            };
            
            app.renderEditProfileModal = function() {
                const modal = app.elements.profileModal;
                const profile = app.state.myProfile;
                modal.innerHTML = `
                    <div class="bg-card w-full max-w-lg rounded-lg shadow-xl relative max-h-[90vh] overflow-y-auto">
                        <button id="close-edit-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl font-bold">&times;</button>
                        <div class="p-6">
                            <h2 class="text-2xl font-bold mb-6">Edit Your Profile</h2>
                            <form id="edit-profile-form">
                                <div class="mb-4">
                                    <label for="edit-name" class="block text-sm font-bold mb-2">Full Name</label>
                                    <input type="text" id="edit-name" class="w-full p-2 border border-border rounded bg-gray-50 dark:bg-slate-700" value="${profile.name}">
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label for="edit-age" class="block text-sm font-bold mb-2">Age</label>
                                        <input type="number" id="edit-age" class="w-full p-2 border border-border rounded bg-gray-50 dark:bg-slate-700" value="${profile.age}">
                                    </div>
                                    <div>
                                        <label for="edit-location" class="block text-sm font-bold mb-2">Location</label>
                                        <input type="text" id="edit-location" class="w-full p-2 border border-border rounded bg-gray-50 dark:bg-slate-700" value="${profile.location}">
                                    </div>
                                </div>
                                 <div class="mb-4">
                                    <label for="edit-bio" class="block text-sm font-bold mb-2">Bio</label>
                                    <textarea id="edit-bio" rows="3" class="w-full p-2 border border-border rounded bg-gray-50 dark:bg-slate-700">${profile.bio}</textarea>
                                </div>
                                <div class="mb-6">
                                    <label class="block text-sm font-bold mb-2">Upload Certificates</label>
                                    <input type="file" id="certificate-upload" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"/>
                                    <div id="uploaded-certs-list" class="mt-3 text-sm space-y-2"></div>
                                </div>
                                <div class="flex justify-end gap-4">
                                    <button type="button" id="cancel-edit-btn" class="bg-gray-200 dark:bg-gray-600 font-semibold py-2 px-6 rounded-full">Cancel</button>
                                    <button type="submit" class="bg-orange-500 text-white font-semibold py-2 px-6 rounded-full hover:bg-orange-600">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                app.elements.profileModal.classList.add('flex');

                document.getElementById('close-edit-modal-btn').addEventListener('click', app.handlers.handleEditProfileClose);
                document.getElementById('cancel-edit-btn').addEventListener('click', app.handlers.handleEditProfileClose);
                document.getElementById('edit-profile-form').addEventListener('submit', app.handlers.handleProfileSave);
                document.getElementById('certificate-upload').addEventListener('change', app.handlers.handleCertUpload);
            };

            app.renderInboxPage = function() {
                const page = document.getElementById('inbox-page');
                page.innerHTML = `<div class="bg-card border border-border rounded-lg shadow-lg"><div class="divide-y divide-border"></div></div>`;
                const container = page.querySelector('.divide-y');

                if (Object.keys(app.state.chats).length === 0) {
                    container.innerHTML = `<p class="p-6 text-center text-gray-500 dark:text-gray-400">Your inbox is empty. Connect with players to start chatting!</p>`;
                    return;
                }

                Object.keys(app.state.chats).forEach(chatId => {
                    const chat = app.state.chats[chatId];
                    const player = app.state.players.find(p => p.id == chatId);
                    if (!player) return;

                    const lastMessage = chat.messages[chat.messages.length - 1];
                    const chatItem = document.createElement('div');
                    chatItem.className = 'p-4 flex items-center hover:bg-gray-50 dark:hover:bg-slate-800/50 cursor-pointer transition';
                    chatItem.dataset.chatId = chatId;
                    
                    chatItem.innerHTML = `
                        <img src="${player.profileImage}" alt="${player.name}" class="w-12 h-12 rounded-full object-cover mr-4">
                        <div class="flex-grow">
                            <div class="flex justify-between">
                                <h3 class="font-bold">${player.name}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${lastMessage.time}</p>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-300 truncate">${lastMessage.text}</p>
                        </div>
                    `;
                    container.appendChild(chatItem);
                    chatItem.addEventListener('click', () => app.handlers.handleInboxItemClick(chatId));
                });
            };
            
            app.renderChatModal = function(chatId) {
                const modal = app.elements.chatModal;
                const chat = app.state.chats[chatId];
                const player = app.state.players.find(p => p.id == chatId);
                if (!chat || !player) return;

                modal.innerHTML = `
                    <div class="bg-card w-full max-w-md h-[70vh] rounded-lg shadow-xl flex flex-col">
                        <header class="flex items-center p-3 border-b border-border">
                            <img src="${player.profileImage}" class="w-10 h-10 rounded-full object-cover mr-3">
                            <h3 class="font-bold text-lg">${player.name}</h3>
                            <button id="close-chat-btn" class="ml-auto text-2xl text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 font-bold">&times;</button>
                        </header>
                        <div id="message-container" class="flex-grow p-4 space-y-4 overflow-y-auto">
                           <!-- Messages will be rendered here -->
                        </div>
                        <footer class="p-3 border-t border-border">
                            <form id="message-form" class="flex gap-2">
                                <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow p-2 border border-border rounded-full bg-gray-50 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <button type="submit" class="bg-orange-500 text-white rounded-full p-2 w-10 h-10 flex-shrink-0 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </form>
                        </footer>
                    </div>
                `;
                app.renderChatMessages(chatId);
                modal.classList.add('flex');

                document.getElementById('close-chat-btn').addEventListener('click', app.handlers.handleChatModalClose);
                document.getElementById('message-form').addEventListener('submit', (e) => app.handlers.handleSendMessage(e, chatId));
            };
            
            app.renderChatMessages = function(chatId) {
                const container = document.getElementById('message-container');
                if (!container) return;
                const chat = app.state.chats[chatId];
                container.innerHTML = chat.messages.map(msg => `
                    <div class="flex ${msg.sender === 0 ? 'justify-end' : 'justify-start'}">
                        <div class="${msg.sender === 0 ? 'chat-bubble-sent' : 'chat-bubble-received'} py-2 px-4 rounded-2xl max-w-xs">
                            ${msg.text}
                        </div>
                    </div>
                `).join('');
                if(document.getElementById('typing-indicator')) {
                    container.innerHTML += `<div id="typing-indicator" class="flex justify-start"><div class="chat-bubble-received py-2 px-4 rounded-2xl">Typing...</div></div>`;
                }
                container.scrollTop = container.scrollHeight;
            };


            // Define handlers
            app.handlers = {
                handleNavClick(e) {
                    const pageId = e.currentTarget.dataset.page;
                    app.switchPage(pageId);
                },
                handleThemeToggle() {
                    app.state.theme = app.state.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('theme', app.state.theme);
                    app.elements.html.classList.toggle('dark');
                    app.elements.themeIconLight.classList.toggle('hidden');
                    app.elements.themeIconDark.classList.toggle('hidden');
                },
                handleNotificationsToggle() {
                    app.elements.notificationsPanel.classList.toggle('hidden');
                    app.renderNotificationsPanel();
                },
                handleEditProfileOpen() {
                    app.renderEditProfileModal();
                },
                handleEditProfileClose() {
                    app.elements.profileModal.classList.remove('flex');
                    app.elements.profileModal.innerHTML = '';
                },
                handleCertUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const list = document.getElementById('uploaded-certs-list');
                    const newCertName = `New Certificate: ${file.name}`;
                    const p = document.createElement('p');
                    p.textContent = `üìÑ ${file.name}`;
                    p.dataset.fileName = file.name;
                    p.dataset.certName = newCertName;
                    list.appendChild(p);
                    e.target.value = ''; // Reset file input
                },
                handleProfileSave(e) {
                    e.preventDefault();
                    app.state.myProfile.name = document.getElementById('edit-name').value;
                    app.state.myProfile.age = document.getElementById('edit-age').value;
                    app.state.myProfile.location = document.getElementById('edit-location').value;
                    app.state.myProfile.bio = document.getElementById('edit-bio').value;

                    const newCerts = document.querySelectorAll('#uploaded-certs-list p');
                    newCerts.forEach(certEl => {
                        app.state.myProfile.certificates.push({ name: certEl.dataset.certName, file: certEl.dataset.fileName });
                    });

                    app.renderMyProfilePage();
                    app.handlers.handleEditProfileClose();
                    app.utils.showToast('Profile updated successfully!', 'success');
                },
                handleInboxItemClick(chatId) {
                    app.renderChatModal(chatId);
                },
                handleChatModalClose() {
                    app.elements.chatModal.classList.remove('flex');
                    app.elements.chatModal.innerHTML = '';
                },
                handleSendMessage(e, chatId) {
                    e.preventDefault();
                    const input = document.getElementById('message-input');
                    const text = input.value.trim();
                    if (!text) return;

                    app.state.chats[chatId].messages.push({ sender: 0, text, time: 'Now' });
                    app.renderChatMessages(chatId);
                    input.value = '';

                    // Simulate reply
                    const container = document.getElementById('message-container');
                    const typingIndicator = document.createElement('div');
                    typingIndicator.id = 'typing-indicator';
                    typingIndicator.className = 'flex justify-start';
                    typingIndicator.innerHTML = `<div class="chat-bubble-received py-2 px-4 rounded-2xl">Typing...</div>`;
                    container.appendChild(typingIndicator);
                    container.scrollTop = container.scrollHeight;

                    setTimeout(() => {
                        document.getElementById('typing-indicator')?.remove();
                        app.state.chats[chatId].messages.push({ sender: chatId, text: "Got it, thanks for the update!", time: 'Now' });
                        app.renderChatMessages(chatId);
                    }, 1500 + Math.random() * 1000);
                },
                handleDistanceChange(e) {
                    const newRadius = e.target.value;
                    app.state.searchRadius = newRadius;
                    document.getElementById('distance-label').textContent = `${newRadius} km`;
                    app.renderPlayerList();
                },
                handleFilterClick(e) {
                    const activity = e.currentTarget.dataset.activity;
                    app.state.activeFilter = activity;
                    
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('bg-orange-500', 'text-white');
                        btn.classList.add('bg-white', 'dark:bg-slate-700', 'text-gray-700', 'dark:text-gray-200');
                    });
                    e.currentTarget.classList.add('bg-orange-500', 'text-white');
                    e.currentTarget.classList.remove('bg-white', 'dark:bg-slate-700', 'text-gray-700', 'dark:text-gray-200');

                    app.renderPlayerList();
                }
            };

            app.renderNotificationsPanel = function() {
                const panel = app.elements.notificationsPanel;
                panel.innerHTML = '<div class="p-3 font-bold border-b border-border">Notifications</div>';
                if(app.state.notifications.length === 0) {
                     panel.innerHTML += '<p class="p-4 text-sm text-gray-500 dark:text-gray-400">No new notifications.</p>';
                     return;
                }
                app.state.notifications.forEach(n => {
                    const notif = document.createElement('div');
                    notif.className = `p-3 border-b border-border text-sm flex items-start gap-3 ${!n.read ? 'bg-orange-500/10' : ''}`;
                    const fromPlayer = app.state.players.find(p => p.id === n.from);
                    if (!fromPlayer) return;
                    notif.innerHTML = `
                        <img src="${fromPlayer.profileImage}" class="w-8 h-8 rounded-full mt-1 object-cover">
                        <div>
                            <p>${n.text}</p>
                            <div class="mt-2 flex gap-2">
                                ${n.type === 'connect_request' ? '<button class="accept-btn text-xs bg-orange-500 text-white px-2 py-1 rounded">Accept</button><button class="decline-btn text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">Decline</button>' : ''}
                            </div>
                        </div>
                    `;
                    panel.appendChild(notif);
                });
            };
            
            // Define utils
            app.utils = {
                getLocation() {
                    navigator.geolocation.getCurrentPosition(pos => {
                        app.state.currentUserLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        document.querySelector('#location-status p').textContent = 'Location found! Showing players near you.';
                        app.renderPlayerList();
                    }, err => {
                        console.warn(`ERROR(${err.code}): ${err.message}`);
                        app.renderPlayerList(); // Render with default location
                    }, { timeout: 8000 });
                },
                showToast(message, type = 'info') {
                    const toast = document.createElement('div');
                    const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
                    toast.className = `toast ${colors[type]} text-white py-2 px-4 rounded-lg shadow-md mb-2`;
                    toast.textContent = message;
                    app.elements.toastContainer.appendChild(toast);
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);
                },
                 calculateDistance(lat1, lon1, lat2, lon2) {
                    if(!lat1 || !lon1 || !lat2 || !lon2) return 0;
                    const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
                    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    return R * c;
                },
            };
        })(App);

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>

